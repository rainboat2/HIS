<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="assets/img/logo-fav.png">
    <title>HIS</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">

    <link rel="stylesheet" type="text/css" href="assets/lib/perfect-scrollbar/css/perfect-scrollbar.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/material-design-icons/css/material-design-iconic-font.min.css"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="assets/lib/jquery.vectormap/jquery-jvectormap-1.2.2.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/jqvmap/jqvmap.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/datetimepicker/css/bootstrap-datetimepicker.min.css"/>
    <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
</head>
<body>
<div class="be-wrapper be-fixed-sidebar">
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-default navbar-fixed-top be-top-header">
        <div class="container-fluid">
            <!-- 左上角log -->
            <div class="navbar-header">
                <a href="#" class="navbar-brand"></a>
            </div>

            <div class="be-right-navbar">
                <ul class="nav navbar-nav navbar-right be-user-nav">
                    <li class="dropdown">
                        <a href="#" data-toggle="dropdown" role="button" aria-expanded="false" class="dropdown-toggle">
                            <img src="assets/img/avatar.png" alt="Avatar">
                            <span class="user-name">${sessionScope.userId}</span>
                        </a>
                        <ul role="menu" class="dropdown-menu">
                            <li>
                                <div class="user-info">
                                    <div class="user-name">${sessionScope.userId}</div>
                                </div>
                            </li>
                            <li>
                                <a onclick="$.quit('${pageContext.request.contextPath}');return false;">
                                    <span class="icon mdi mdi-power"></span>注销
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
                <!--                <div class="page-title">收费员>>收费</div>-->
            </div>
        </div>
    </nav>

    <!-- 左侧边导航栏 -->
    <div class="be-left-sidebar">
        <div class="left-sidebar-wrapper"><a href="#" class="left-sidebar-toggle">Dashboard</a>
            <div class="left-sidebar-spacer">
                <div class="left-sidebar-scroll">
                    <div class="left-sidebar-content">
                        <ul class="sidebar-elements">
                            <li class="divider">菜单</li>
                            <li class="parent"><a href="#"><i class="icon mdi mdi-face"></i><span>挂号收费</span></a>
                                <ul class="sub-menu">
                                    <li><a href="register.html">挂号</a>
                                    </li>
                                    <li><a href="withdrawRegistration.html">退号</a>
                                    </li>
                                    <li><a href="abnormalInvoiceProcess.html">异常发票处理</a>
                                    </li>
                                    <li class="active"><a href="#">收退费</a>
                                    </li>
                                    <li><a href="dailySettlement.html">日结</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页面主内容 -->
    <div class="be-content">
        <div class="main-content container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div class="panel panel-default panel-table">
                        <div class="panel-heading"></div>
                        <!-- 信息输入/查看面板-->
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <table class="col-sm-12">
                                        <tr>
                                            <td style="width:15%"><b>患者信息查询</b></td>
                                        </tr>
                                        <tr>
                                            <td style="width:8%;text-align:center;">
                                                <label for="medicalNo">病历号</label>
                                            </td>
                                            <td class="col-sm-3">
                                                <input id = "medicalNo" type="text" placeholder="病历号" autocomplete="off" class="form-control input-sm">
                                            </td>
                                            <td class="col-sm-1">
                                                <select id = "payWithdrawChoice" name = "deptId" class=" input-sm">
                                                    <option value="pay" selected>收费</option>
                                                    <option value="withdraw" >退费</option>
                                                </select>
                                            </td>
                                            <td>
                                                <button id="getDrugs" class="btn btn-space btn-primary" onclick="getDrugs()">
                                                    <i class="icon icon-left mdi mdi-search"></i> 搜索
                                                </button>
                                                <label  id="finder-err" class="error-message" style="margin: auto;text-align: center;color: red"></label>
                                            </td>

                                        </tr>
                                        <tr>
                                            <td><b>患者信息确认</b></td>
                                        </tr>
                                        <tr>
                                            <td style="width:8%;text-align:center;">
                                                <label for="name">姓名</label>
                                            </td>
                                            <td style="width:24%;">
                                                <input id="name" type="text" readonly="readonly" class="form-control input-sm">
                                            </td>
                                            <td style="width:8%;;text-align:center;">
                                                <label for="idNumber">身份证号</label>
                                            </td>
                                            <td style="width:24%">
                                                <input id="idNumber" type="text" readonly="readonly" class="form-control input-sm">
                                            </td>
                                            <td style="width:8%;;text-align:center;">
                                                <label for="address">家庭住址</label>
                                            </td>
                                            <td style="width:24%">
                                                <input id="address" type="text" readonly="readonly" class="form-control input-sm">
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="panel-heading">
                            患者项目信息
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <table id="drug-table" class="table table-striped table-hover table-fw-widget ">
                                        <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select-all" value="1"></th>
                                            <th>病例号</th>
                                            <th>姓名</th>
                                            <th>项目id</th>
                                            <th>项目名称</th>
                                            <th>单价</th>
                                            <th>数量</th>
                                            <th>状态</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="row"><div class="col-sm-1"></div></div>
                        <div class="row">
                            <div class="col-sm-1"></div>
                            <div class="col-sm-2">
                                <button class="btn btn-space btn-primary" onclick="payWithdraw()">
                                    项目结算
                                </button>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


</body>
<script src="assets/lib/jquery/jquery.min.js" type="text/javascript"></script>
<script src="assets/lib/perfect-scrollbar/js/perfect-scrollbar.jquery.min.js" type="text/javascript"></script>
<script src="assets/js/main.js" type="text/javascript"></script>
<!--<script src="assets/js/myjs/payDrug.js" type="text/javascript"></script>-->
<script src="assets/js/myjs/common.js" type="text/javascript" charset="GBK"></script>
<script src="assets/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery/jquery.min.js" type="text/javascript"></script>
<script src="assets/lib/perfect-scrollbar/js/perfect-scrollbar.jquery.min.js" type="text/javascript"></script>
<script src="assets/js/main.js" type="text/javascript"></script>
<script src="assets/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/dataTables.bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/dataTables.buttons.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.html5.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.flash.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.print.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.colVis.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.bootstrap.js" type="text/javascript"></script>
<script src="assets/js/app-tables-datatables.js" type="text/javascript"></script>
<script src="assets/lib/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery.nestable/jquery.nestable.js" type="text/javascript"></script>
<script src="assets/lib/moment.js/min/moment.min.js" type="text/javascript"></script>
<script src="assets/lib/datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script src="assets/lib/daterangepicker/js/daterangepicker.js" type="text/javascript"></script>
<script src="assets/lib/select2/js/select2.min.js" type="text/javascript"></script>
<script src="assets/lib/select2/js/select2.full.min.js" type="text/javascript"></script>
<script src="assets/lib/bootstrap-slider/js/bootstrap-slider.js" type="text/javascript"></script>
<script src="assets/js/myjs/common.js"  type="text/javascript"></script>
<script type="text/javascript" src="assets/lib/layui/layui.all.js"></script>


<script>

    var choice = $("#payWithdrawChoice").val();

    var pay_data = [
        ["", "600601", "王五", "86979474000208", "金霉素眼膏", 0.86, 1 , "未缴费"],
        ["", "600601", "王五", "86979474000208", "红霉素眼膏", 1.86, 1 , "未缴费"],
        ["", "600601", "王五", "86979474000209", "酚酞", 10.42, 3 , "未缴费"],

        ["", "600601", "王五", "86979474000208", "四季青", 61.09, 1 , "未进行"],
        ["", "600601", "王五", "86979474000209", "六味地黄丸", 26.7, 2 , "未进行"],
    ];

    // 根据病历号，查找所有对应的开立药品
    function getDrugs() {
        if (!check_Medical_no())
            return;

        const medicalNo = document.getElementById("medicalNo").value;

        if (medicalNo === '1'){                            //600601
            layer.msg("病历号不存在",{icon:2,time:1000});
        }
        else{
            let p = ['王五','123456789987654321','沈阳'];
            $("#name").val(p[0]);
            $("#idNumber").val(p[1]);
            $("#address").val(p[2]);

            // console.log(choice)
            choice = $("#payWithdrawChoice").val();
            const table = $("#drug-table").DataTable();
            table.clear();
            for (let r of pay_data){
                // console.log(r[7]);
                if (r[7] === "未缴费" && choice === "pay"){     //尚未缴费
                    table.row.add(r);
                }
                if (r[7] === "未进行" && choice === "withdraw"){   //已经缴费但尚未进行
                    table.row.add(r);
                }
            }
            table.draw();
        }

    }

    function check_Medical_no() {
        const medicalNo = document.getElementById("medicalNo").value;
        const num = /^[1-9]\d*$/;
        const err = $("#finder-err");
        if (medicalNo === null || !num.test(medicalNo)){
            err.text("病历号必需为数字");
            return false;
        }
        err.text("");
        return true;
    }

    function payWithdraw() {
        if (!check_Medical_no())
            layer.msg("请正确输入病历号",{icon:2,time:1000});
        if (choice === "pay"){
            console.log("pay");
            pay();
        }
        else{
            console.log("withdraw");
            withdraw();
        }

    }

    function withdraw() {
        var totalFee = countFee().toFixed(2);
        // $("#invoiceId")[0].value = 13412421342;

        layer.open({
            title:'退费确认',
            type:2,
            area: ['300px', '250px'],
            content:"withdraw.html?receivable=" + totalFee,

            btn: ['确定', '取消'],
            btn1: function (index, layero) {
                layer.close(index);
                layer.msg("已完成退费",{icon:1,time:1000});
                setTimeout(function () {


                    const table = $("#drug-table")[0];
                    const rows = table.rows;
                    let chaneglist = [];
                    for (let i = 1; i < rows.length; i++){
                        const $cell = $(rows[i].cells[0].firstChild);
                        if (!$cell.prop('checked'))
                            continue;
                        let changeName = rows[i].cells[4].firstChild.nodeValue;
                        console.log(changeName);
                        for (let j = 0; j < pay_data.length; ++j){
                            if (pay_data[j][4] === changeName)
                                pay_data[j][7] = "cool";
                        }
                    }
                    const table2 = $("#drug-table").DataTable();
                    table2.clear();
                    for (let r of pay_data){
                        if (r[7] === "未进行"){     //尚未进行
                            table2.row.add(r);
                        }
                    }
                    table2.draw();

                }, 1000);
            },
            btn2: function (index, layero) {
                layer.close(index);
            },
        });
    }

    function pay() {
        var totalFee = countFee().toFixed(2);
        // $("#invoiceId")[0].value = 13412421342;

        layer.open({
            title:'收费确认',
            type:2,
            area: ['300px', '350px'],
            content:"pay.html?receivable=" + totalFee,

            btn: ['确定', '取消'],
            btn1: function (index, layero) {
                layer.close(index);
                layer.msg("已完成收费",{icon:1,time:1000});
                setTimeout(function () {


                    const table = $("#drug-table")[0];
                    const rows = table.rows;
                    let chaneglist = [];
                    for (let i = 1; i < rows.length; i++){
                        const $cell = $(rows[i].cells[0].firstChild);
                        if (!$cell.prop('checked'))
                            continue;
                        let changeName = rows[i].cells[4].firstChild.nodeValue;
                        console.log(changeName);
                        for (let j = 0; j < pay_data.length; ++j){
                            if (pay_data[j][4] === changeName)
                                pay_data[j][7] = "未进行";
                        }
                    }
                    const table2 = $("#drug-table").DataTable();
                    table2.clear();
                    for (let r of pay_data){
                        if (r[7] === "未缴费"){     //尚未缴费
                            table2.row.add(r);
                        }
                    }
                    table2.draw();

                }, 1000);
            },
            btn2: function (index, layero) {
                layer.close(index);
            },
        });
    }





    function countFee() {
        const table = $("#drug-table")[0];
        const rows = table.rows;

        let fee = 0.0;
        presDetailIds = [];
        index = 0;
        for (let i = 1; i < rows.length; i++){
            const $cell = $(rows[i].cells[0].firstChild);
            if (!$cell.prop('checked'))
                continue;

            presDetailIds[index++] = +rows[i].cells[3].firstChild.nodeValue;

            const price = +rows[i].cells[5].firstChild.nodeValue;
            const amount = +rows[i].cells[6].firstChild.nodeValue;
            fee = fee + price * amount;
        }
        return fee;
    }

    function changeState(state) {
        const data = {
            presDetailIds: stringify(collectSelected()),
            state: state
        };
        console.log(data);
        $.ajax({
            type: "get",
            contentType: "application/json",
            dataType: "json",
            url: $.pagePath + "/payFee",
            data: data,
            success: function (rs) {
                cancel();
                window.alert("成功");
                $("#getDrugs").trigger("click");
            },
            error: function () {
                window.alert("异常");
            }
        })
    }


</script>


<script type="text/javascript">
    $(document).ready(function(){
        App.init();
        init_pay_table();
        init_table_checkbox()
    });

    function init_pay_table(){
        $.extend( true, $.fn.dataTable.defaults, {

        } );

        const dataTableConfig = {
            // "data":pay_data,
            "dom":
                "<'row be-datatable-header'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row be-datatable-body'<'col-sm-12'tr>>" +
                "<'row be-datatable-footer'<'col-sm-5'i><'col-sm-7'p>>",

            "bPaginate": true,  //是否分页。
            "bStateSave": true,
            "aLengthMenu": [5, 10, 15],
            "language": {
                "processing": "数据查询中",
                "emptyTable": "无付费项目信息",
                "info": "显示 _START_ 到 _END_ 条数据 共 _TOTAL_ 条数据",
                "infoEmpty": "无数据",
                "infoFiltered": "(在 _MAX_ 条数据中查询)",
                "lengthMenu": "显示 _MENU_ 条数据",
                "search": "查询:",
                "zeroRecords": "没有找到对应的数据",
                "paginate": {
                    "previous":"上一页",
                    "next": "下一页",
                    "last": "末页",
                    "first": "首页"
                },
               " sSearchPlaceholder": "病例号/医技项目id"
            },
            'columnDefs': [{
                'targets': 0,
                'searchable': false,
                'orderable': false,
                'render': function (data, type, full, meta){
                    return '<input type="checkbox"">';
                    // return '<input type="checkbox" name="id[]" value="' + $('<div/>').text(data).html() + '">';
                }
            }]
        };

        $("#drug-table").dataTable(dataTableConfig);
    }

    function init_table_checkbox() {
        $("#select-all").on('click', function () {
            const table = $("#drug-table").DataTable();
            // 获取所有显示在表格中的行
            const rows = table.rows({'search': 'applied'}).nodes();
            $('input[type="checkbox"]', rows).prop('checked', this.checked)
        });
    }

</script>
</html>