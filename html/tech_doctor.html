<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="assets/img/logo-fav.png">
    <title>HIS</title>
    <link rel="stylesheet" type="text/css" href="assets/css/style_me.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/perfect-scrollbar/css/perfect-scrollbar.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/material-design-icons/css/material-design-iconic-font.min.css"/>
    <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/datatables/css/dataTables.bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/libme/jquery-ui-1.12.1/jquery-ui.css"/>
</head>
<body>
<div class="be-wrapper be-fixed-sidebar">
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-default navbar-fixed-top be-top-header">
        <div class="container-fluid">
            <!-- 左上角log -->
            <div class="navbar-header">
                <a href="#" class="navbar-brand"></a>
            </div>

            <div class="be-right-navbar">
                <ul class="nav navbar-nav navbar-right be-user-nav">
                    <li class="dropdown">
                        <a href="#" data-toggle="dropdown" role="button" aria-expanded="false" class="dropdown-toggle">
                            <img src="assets/img/avatar.png" alt="Avatar">
                            <span class="user-name">医技医生</span>
                        </a>
                        <ul role="menu" class="dropdown-menu">
                            <li>
                                <div class="user-info">
                                    <div class="user-name">医技医生</div>
                                </div>
                            </li>
                            <li>
                            </li>
                        </ul>
                    </li>
                </ul>
                <div class="page-title"></div>
            </div>
        </div>
    </nav>

    <!-- 左侧边导航栏 -->
    <div class="be-left-sidebar">
        <div class="left-sidebar-wrapper"><a href="#" class="left-sidebar-toggle">Dashboard</a>
            <div class="left-sidebar-spacer">
                <div class="left-sidebar-scroll">
                    <div class="left-sidebar-content">
                        <ul class="sidebar-elements">
                            <li class="divider">菜单</li>
                            <li class="parent"><a href="#"><i class="icon mdi mdi-face"></i><span>医技医生</span></a>
                                <ul class="sub-menu">
                                    <li class="active"><a href="#">医技处置</a>
                                    </li>
                                    <li><a href="tech_info.html">医技管理</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页面主内容 -->
    <div class="be-content">
        <div class="main-content container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div class="panel panel-default panel-table">
                        <div class="panel-heading">医技处置
                        </div>
                        <div class="panel-body">
                            <table id="patient-table" class="table table-striped table-hover table-fw-widget">
                                <thead>
                                <tr>
                                    <th>
                                    </th>
                                    <th>病例号</th>
                                    <th>医技项目id</th>
                                    <th>医技项目名称</th>
                                    <th>项目类型</th>
                                    <th>项目状态</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="input-result-form" style="display: none">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <form action="#" class="form-horizontal group-border-dashed">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <input type="file" name="file-1" id="file-1" data-multiple-caption="{count} files selected" multiple class="inputfile">
                                <label for="file-1" class="btn-default"> <i class="mdi mdi-upload"></i><span>点击选择文件</span></label>
                                <input type="text" value="  选中文件路径" style="border: 0px" disabled="disabled">
                            </div>

                            <div class="col-sm-12">
                                <label for="result-area">结果说明</label>
                                <textarea id="result-area" class="form-control"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="show-result-form" style="display: none">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <form action="#" class="form-horizontal group-border-dashed">
                        <div class="form-group">
                            <div class="col-sm-12">
                                <a href="assets/img/gallery/check.jpg" target="_blank">
                                    <img class="center-block" src="assets/img/gallery/check.jpg" width="100" height="160">
                                </a>
                            </div>
                            <div class="col-sm-12">
                                <p></p>
                            </div>
                            <div class="col-sm-12">
                                <label for="show-result-area"><b>结果说明</b></label>
                                <textarea id="show-result-area" class="form-control" style="font-size: small">这里是检查单的说明</textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

</body>


<script src="assets/lib/jquery/jquery.min.js" type="text/javascript"></script>
<script src="assets/libme/jquery-ui-1.12.1/external/jquery/jquery.js" type="text/javascript"></script>
<script src="assets/libme/jquery-ui-1.12.1/jquery-ui.js" type="text/javascript"></script>
<script src="assets/lib/perfect-scrollbar/js/perfect-scrollbar.jquery.min.js" type="text/javascript"></script>
<script src="assets/js/main.js" type="text/javascript"></script>
<script src="assets/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/dataTables.bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/dataTables.buttons.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.html5.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.flash.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.print.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.colVis.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.bootstrap.js" type="text/javascript"></script>
<script src="assets/js/app-tables-datatables.js" type="text/javascript"></script>
<script src="assets/lib/layui/layui.all.js" type="text/javascript"></script>


<script type="text/javascript">

    const data = [
        ["","3242323","120500003","中清创缝合","处置","待执行","确认执行"],
        ["","3242323","210101002","脑室碘水造影","检查","已执行","录入结果"],
        ["","3242323","210103009","尿β2微球蛋白测定（化X发光法）J","检验","已完成","查看结果"],
        ["","3242323","210103015","肠内高营养治疗","处置","已取消","查看结果"]
    ]
    $(document).ready(function(){
        App.init();
        init_doctor_table();
    });

    function init_doctor_table(){
        const dataTableConfig = {
            "dom":"<'row be-datatable-header'<'col-sm-6' <'toolbar'>><'pull-right'B>>" +
            "<'row be-datatable-body'<'col-sm-12'tr>>" +
            "<'row be-datatable-footer'<'col-sm-6'i><'col-sm-6'p>>",

            "bPaginate": true,  //是否分页。
            "bStateSave": true,
            "aLengthMenu": [5, 10, 15],
            "language": {
                "processing": "数据查询中",
                "emptyTable": "在输入框中输入患者病例号/医技处置id以获取数据",
                "info": "显示 _START_ 到 _END_ 条数据 共 _TOTAL_ 条数据",
                "infoEmpty": "无数据",
                "infoFiltered": "(在 _MAX_ 条数据中查询)",
                "lengthMenu": "显示 _MENU_ 条数据",
                "search": "查询:",
                "zeroRecords": "没有找到对应的数据",
                "paginate": {
                    "previous":"上一页",
                    "next": "下一页",
                    "last": "末页",
                    "first": "首页"
                },
                sSearchPlaceholder: "病例号/医技项目id"
            },
            'columnDefs': [{
                'targets': 0,
                'searchable': false,
                'orderable': false,
                'render': function (data, type, full, meta){
                    const div = $('<div class="be-checkbox be-checkbox-sm"></div>');
                    const input = $("<input type='checkbox' name='id[]'>");
                    const label = $("<label></label>")
                    input.attr('id', meta.row);
                    label.attr('for', meta.row);
                    div.append(input);
                    div.append(label);
                    input.attr('onclick', 'cancel_all_except(' + meta.row + ')');
                    return div.prop("outerHTML");
                }
            },{
                'targets': 6,
                'searchable': false,
                'orderable' : false,
                'render': function (data, type, row, meta) {
                    const button = $("<input type='button' class='btn btn-space btn-primary'>");
                    button.val(data);

                    if (data === "确认执行"){
                        button.attr("onclick", "confirm(" + meta.row + ")");
                    } else if (data === "录入结果")
                        button.attr('onclick', "input_result(" + meta.row + ")");
                    else if (data === "查看结果")
                        button.attr('onclick', "show_result(" + meta.row + ")");
                    else
                        button.text("不可达的按钮");
                    return button.prop("outerHTML");
                }
            }
            ],
            "buttons": [
                {
                    text: "取消所选项目",
                    className: "btn btn-space btn-danger",
                    action:function () {
                        cancel_item();
                    }
                },
            ]
        };
        $("#patient-table").dataTable(dataTableConfig);
        $("div.toolbar").html("<input type='text' id='custom-search' placeholder='病例号/医技项目id' class='input-sm form-control'>");
        $("#custom-search").autocomplete({
            source: ["3242323", "210103015", "210103009", "210101002", "120500003"],
            select: function (event, ui) {
                $("#custom-search").val(ui.item.value);
                search_and_fill_table();
            }
        })
        $("#custom-search").keyup(function (event) {
            // 监听回车键
            if (event.keyCode === 13)
                search_and_fill_table();
        })
    }

    function cancel_item() {
        const table = $("#patient-table").DataTable();
        // 找到被选中的项目
        let row_idx = -1;
        table.rows().every(function (index) {
            if ($("#" + index).prop("checked"))
                row_idx = index;
        })

        if (row_idx === -1){
            layer.msg("未选中任何项目", {icon: 2, time: 1000});
        }else if (table.cell(row_idx, 5).data() !== '待执行'){
            layer.msg("只有待执行的项目才能被取消", {icon: 2, time: 1500});
        } else {
            const name = table.cell(row_idx, 3).data();
            layer.confirm("真的要将项目'" + name + "'取消吗？该操作将不可逆!",{
                btn: ['确认', '取消'],
                btn1: function (index) {
                    table.cell(row_idx, 5).data("已取消");
                    table.cell(row_idx, 6).data("查看结果");
                    layer.close(index);
                    layer.msg("项目" + name + "已被取消!");
                },
                btn2: function () {
                }
            })
        }
    }

    // 取消所有的单选框，除了指定的那个外
    function cancel_all_except(row_idx) {
        const checkbox = $("#" + row_idx);
        // 一个checkbox被选中时，应该取消其他的选中
        if (checkbox.prop('checked')){
            const table = $("#patient-table").DataTable();
            table.rows().every(function (index) {
                if (index === row_idx) return;
                $("#" + index).prop('checked', false);
            })
        }
    }

    function search_and_fill_table() {
        const text = $("#custom-search").val();
        const table = $("#patient-table").DataTable();
        table.clear();
        for (let r of data){
            if (r[1] === text || r[2] === text){
                table.row.add(r);
            }
        }
        table.draw();
    }

    // 确认执行
    function confirm(row_idx) {
        console.log(row_idx);
        layer.confirm("确认该项已经完成了吗？",{
            btn:["确认", "取消"],
            btn1: function(index, layero){
                // 修改项目状态，修改按钮文字和onclick事件
                const table = $("#patient-table").DataTable();
                table.cell(row_idx, 5).data("已执行");
                table.cell(row_idx, 6).data("录入结果");

                    layer.close(index);
                    layer.msg("成功执行", {icon: 1, time: 1500});
                },
                btn2: function(index, layero){
                }
            })
        }

        // 录入结果
        function input_result(row_idx) {
            layer.open({
                type: 6,
                title: "录入结果",
                btn: ["确认", "取消"],
                content: $("#input-result-form").html(),
                btn1: function (index, layero) {
                    const table = $("#patient-table").DataTable();
                    table.cell(row_idx, 5).data("已完成");
                    table.cell(row_idx, 6).data("查看结果");

                    layer.close(index);
                    layer.msg("结果已保存", {icon: 1, time: 1500});
            },
            btn2: function (index, layero) {
            }
        });
    }

    // 查看结果
    function show_result(row_idx) {
        layer.open({
            type: 6,
            title: "查看结果",
            btn: ["确认"],
            area: "300px",
            content: $("#show-result-form").html(),
            btn1: function (index, layero) {
                layer.close(index);
            },
        })
    }
</script>
</html>