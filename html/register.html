<!--挂号收费员挂号界面-->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="assets/img/logo-fav.png">
    <title>HIS</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">

    <link rel="stylesheet" type="text/css" href="assets/lib/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="assets/css/style_me.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/perfect-scrollbar/css/perfect-scrollbar.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/material-design-icons/css/material-design-iconic-font.min.css"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="assets/lib/datetimepicker/css/bootstrap-datetimepicker.min.css"/>
    <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
</head>
<body>
<div class="be-wrapper be-fixed-sidebar">
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-default navbar-fixed-top be-top-header">
        <div class="container-fluid">
            <!-- 左上角log -->
            <div class="navbar-header">
                <a href="#" class="navbar-brand"></a>
            </div>

            <div class="be-right-navbar">
                <ul class="nav navbar-nav navbar-right be-user-nav">
                    <li class="dropdown">
                        <a href="#" data-toggle="dropdown" role="button" aria-expanded="false" class="dropdown-toggle">
                            <img src="assets/img/avatar.png" alt="Avatar">
                            <span class="user-name">${sessionScope.userId}</span>
                        </a>
                        <ul role="menu" class="dropdown-menu">
                            <li>
                                <div class="user-info">
                                    <div class="user-name">${sessionScope.userId}</div>
                                </div>
                            </li>
                            <li>
                                <a onclick="$.quit('${pageContext.request.contextPath}');return false;">
                                    <span class="icon mdi mdi-power"></span>注销
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
<!--                <div class="page-title">挂号收费员>>挂号</div>-->
            </div>
        </div>
    </nav>

    <!-- 左侧边导航栏 -->
    <div class="be-left-sidebar">
        <div class="left-sidebar-wrapper"><a href="#" class="left-sidebar-toggle">Dashboard</a>
            <div class="left-sidebar-spacer">
                <div class="left-sidebar-scroll">
                    <div class="left-sidebar-content">
                        <ul class="sidebar-elements">
                            <li class="divider">菜单</li>
                            <li class="parent"><a href="#"><i class="icon mdi mdi-face"></i><span>挂号收费</span></a>
                                <ul class="sub-menu">
                                    <li class="active"><a href="#">挂号</a>
                                    </li>
                                    <li><a href="withdrawRegistration.html">退号</a>
                                    </li>
                                    <li><a href="abnormalInvoiceProcess.html">异常发票处理</a>
                                    </li>
                                    <li><a href="payWithdraw.html">收退费</a>
                                    </li>
                                    <li><a href="dailySettlement.html">日结</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页面主内容 -->
    <div class="be-content">
        <div class="main-content container-fluid">
            <div style="width: 49%;height: 100%;position:relative;float:left">
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default panel-border-color panel-border-color-primary">
                            <div class="panel-heading panel-heading-divider">挂号信息</div>
                            <div class="panel-body">
                                <form id = "reg-form" name = "reg-form" action="#" onsubmit="return false"
                                      class="form-horizontal group-border-dashed">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">患者姓名</label>
                                        <div class="col-sm-6">
                                            <input name = "patName" id = "patName"
                                                   type="text" placeholder="患者姓名" class="form-control input-sm">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">身份证号</label>
                                        <div class="col-sm-6">
                                            <input name = "patId" id = "patId"
                                                   type="text" placeholder="身份证号" class="form-control input-sm">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label xs-pt-20">性别</label>
                                        <div class="col-sm-6">
                                            <div class="be-radio-icon inline">
                                                <input type="radio" checked="checked" name="gender" value="female" id="gender-rad1">
                                                <label for="gender-rad1"><span class="mdi mdi-female"></span></label>
                                            </div>
                                            <div class="be-radio-icon inline">
                                                <input type="radio" name="gender" value = "male" id="gender-rad2">
                                                <label for="gender-rad2"><span class="mdi mdi-male-alt"></span></label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label"> 生日 </label>
                                        <div class="col-md-6 col-xs-7">
                                            <div data-min-view="2" data-date-format="yyyy-mm-dd" class="input-group date datetimepicker">
                                                <input name = "birthday" id = "birthday"
                                                       size="16" type="text" value="" class="form-control input-sm">
                                                <span class="input-group-addon btn btn-primary">
                                                    <i class="icon-th mdi mdi-calendar"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="address" class="col-sm-3 control-label">地址</label>
                                        <div class="col-sm-6">
                                            <input name = "address" id = "address" type="text"  class="form-control input-sm">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-3 control-label">是否打印</label>
                                        <div class="col-sm-6 xs-pt-5">
                                            <div class="switch-button switch-button-sm">
                                                <input name = "printed" id = "printed" type="checkbox" checked="">
                                                <span><label for="printed"></label></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="deptId" class="col-sm-3 control-label">科室名称</label>
                                        <div class="col-sm-6">
                                            <select id = "deptId" name = "deptId" class="form-control input-sm">
                                                    <option value="请选择挂号科室">请选择挂号科室</option>
                                                    <option value="儿科">儿科</option>
                                                    <option value="口腔科">口腔科</option>
                                                    <option value="眼科">眼科</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="reglCode" class="col-sm-3 control-label">挂号级别</label>
                                        <div class="col-sm-6">
                                            <select id = "reglCode" name = "reglCode" class="form-control input-sm">
                                                    <option value="请选择挂号级别">请选择挂号级别</option>
                                                    <option value="普通号">普通号</option>
                                                    <option value="专家号">专家号</option>
                                                    <option value="急诊号">急诊号</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="odId" class="col-sm-3 control-label">医生id</label>
                                        <div class="col-sm-4">
                                            <input name = "odId" id = "odId" readonly="readonly"
                                                   type="text" class="form-control input-sm">
                                        </div>
                                        <button onclick="getDoctors()" class="btn btn-space btn-primary">查找医生</button>
                                    </div>
                                    <div class="form-group">
                                        <label for="type" class="col-sm-3 control-label">结算类别</label>
                                        <div class="col-sm-6">
                                            <select  id = "type" name = "type" class="form-control input-sm">
                                                <option>请选择结算类别</option>
                                                <option>自费</option>
                                                <option>医保</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-2 col-sm-10">
                                            <button type="submit" onclick="registration()" class="btn btn-space btn-primary">挂号</button>
                                            <button onclick="reset('reg-form')" class="btn btn-space btn-default">清空</button>
                                            <p id = "reg-err" class="error-message error-description"></p>
                                        </div>
                                    </div>
                                    <input type="hidden" name="cId" value="${sessionScope.userId}">
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="width: 49%;height: 100%;position: relative;float:right">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="panel panel-default panel-border-color panel-border-color-primary">
                            <div class="panel-heading panel-heading-divider">患者查找</div>
                            <div class="panel-body">
                                <form id = "patient-finder" name="patient-finder" onsubmit="return false" class="form-horizontal">
                                    <div class="form-group xs-mt-10">
                                        <label for="medicalNo" class="col-sm-2 control-label">病历号</label>
                                        <div class="col-sm-10">
                                            <input id="medicalNo" name = "medicalNo" placeholder="病历号" class="form-control input-sm">
                                        </div>
                                    </div>
                                    <div class="row xs-pt-15">
                                        <div class="col-xs-6">
                                            <p class="text-right">
                                                <button type="submit" onclick="findPatient()" class="btn btn-space btn-primary">查找并填入</button>
                                                <button onclick="reset('patient-finder')" class="btn btn-space btn-default">清空</button>
                                            </p>
                                            <p class="text-right" id = "finder-err" style="color: Red"></p>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 医生信息表格 -->
                <div class="row">
                    <div class="col-sm-12">
                        <div class="panel panel-default panel-table">
                            <div class="panel-heading">
                                医生信息
                            </div>
                            <div class="panel-body">
                                <table id="doctor-table" class="table table-striped table-hover table-fw-widget">

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="assets/lib/jquery/jquery.min.js" type="text/javascript"></script>
<script src="assets/lib/perfect-scrollbar/js/perfect-scrollbar.jquery.min.js" type="text/javascript"></script>
<script src="assets/js/main.js" type="text/javascript"></script>
<script src="assets/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/dataTables.bootstrap.min.js" type="text/javascript"></script>
<script src="assets/js/app-tables-datatables.js" type="text/javascript"></script>
<script src="assets/lib/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery.nestable/jquery.nestable.js" type="text/javascript"></script>
<script src="assets/lib/moment.js/min/moment.min.js" type="text/javascript"></script>
<script src="assets/lib/datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script src="assets/lib/daterangepicker/js/daterangepicker.js" type="text/javascript"></script>
<script src="assets/lib/select2/js/select2.min.js" type="text/javascript"></script>
<script src="assets/lib/select2/js/select2.full.min.js" type="text/javascript"></script>
<script src="assets/lib/bootstrap-slider/js/bootstrap-slider.js" type="text/javascript"></script>
<script src="assets/js/app-form-elements.js" type="text/javascript"></script>
<script type="text/javascript" src="assets/lib/layui/layui.all.js"></script>


<script>

    $(function () {
        $("#deptId").change(function(){
            $("#reglCode option:gt(0)").removeAttr("selected");
            $('#odId').val('');
            var doctors = [];
            fillDoctorTable(doctors);
        });

        $("#reglCode").change(function () {
            $('#odId').val('');
            var doctors = [];
            fillDoctorTable(doctors)
        })
    });



    function reset(formName){
        document.getElementById(formName).reset();
    }

    function registration() {
        if (!check_reg())
            return;

        const name = document.forms["reg-form"]["patName"].value;
        const dept = document.forms["reg-form"]["deptId"].value;
        const doc = document.forms["reg-form"]["odId"].value;
            layer.confirm('已成功挂号' +
                '\n患者姓名：' + name +
                '\n挂号科室：' + dept +
                '\n挂号医生' + doc, {
                btn: ['确定'] //可以无限个按钮
            }, function(index){
                window.location.reload();
            });
    }

    // 将医生信息填充到挂号信息中
    function fillReg(id) {
        const row = document.getElementById('doctor-table').rows[id];
        document.getElementById("odId").value = row.cells[0].innerHTML;
    }

    // 从服务器请求医生信息
    function getDoctors() {
        const deptId = $('#deptId').children('option:selected').val();
        const regCode = $('#reglCode').children('option:selected').val();

        if (deptId === '请选择挂号科室' || regCode === '请选择挂号级别'){
            layer.msg("请先完成挂号科室和挂号级别的填写",{icon:2,time:3000});
            return;
        }

        var doctors = [];
        doctors[0] = new Doctor(parseInt(Math.random() * 1000), '张三', regCode, deptId , '6', 10);
        doctors[1] = new Doctor(parseInt(Math.random() * 1000), '李四', regCode, deptId, '2', 10);
        fillDoctorTable(doctors);
    }

    function fillDoctorTable(doctors) {
        var table = $("#doctor-table").DataTable();
        table.clear();

        for (var i = 0; i < doctors.length; i++){
            const doctor = doctors[i];
            table.row.add({
                "odId": doctor.odId,
                "name": doctor.name,
                "reglCode": doctor.reglCode,
                "deptName": doctor.deptName,
                "patNumber": doctor.patNumber,
                "limitation": doctor.limitation,
                "operate": "<button onclick='fillReg(" + (i + 1) +")'" +
                    "class='btn btn-rounded btn-space btn-default'>填入</button>"
                }
            )
        }
        table.draw();
    }


    // 查找患者信息
   function findPatient() {
        if (!check_Medical_no())
            return;

        const mdNo = $("input[ name='medicalNo' ] ").val();
        document.getElementById("finder-err").innerHTML = "";
        if (mdNo === '1')
            layer.msg("病历号不存在",{icon:2,time:1000});
        else{
            let p = new PatientInfo('李六','123456789987654321','沈阳',true, '2020-1-1');
            fillPatient(p);
        }
    }


</script>




<script type="text/javascript">

    $(document).ready(function(){
        //initialize the javascript
        App.init();
        App.formElements();
        init_doctor_table();

    });

    // $().ready(function () {
    //     layer.confirm('是否睡觉？', {
    //         btn: ['确定', '取消'] //可以无限个按钮
    //     }, function(index){
    //         layer.msg("请输入正确的病历号",{icon:1,time:1000});
    //         setTimeout(function(){window.location.reload();}, 1000);
    //
    //     }, function(index){
    //         //按钮【按钮二】的回调
    //     });
    //
    //     // layer.open({
    //     //     title:'收费确认',
    //     //     id: (new Date()).valueOf(),
    //     //     type:2,
    //     //     area: ['520px', '420px'],
    //     //     content:"patientmoney.html"
    //     // })
    //
    // });

    function fillPatient(patient) {
        document.getElementById('patName').value = patient.name;
        if (patient.isMale){
            document.getElementById("gender-rad1").checked = "";
            document.getElementById("gender-rad2").checked = "checked";
        }else{
            document.getElementById("gender-rad1").checked = "checked";
            document.getElementById("gender-rad2").checked = "";
        }
        document.getElementById('patId').value = patient.idNumber;
        document.getElementById('address').value = patient.address;
        document.getElementById('birthday').value = patient.birthday;
    }

    class PatientInfo{
        constructor(name, id, address, isMale, birth){
            this.name = name;
            this.idNumber = id;
            this.address = address;
            this.isMale = isMale;
            this.birthday = birth;
        }
    }

    class Doctor{
        constructor(odId, name, reglCode, deptName, patNumber, limitation){
            this.odId=odId;
            this.name=name;
            this.reglCode=reglCode;
            this.deptName=deptName;
            this.patNumber=patNumber;
            this.limitation=limitation;
        }
    }


    function init_doctor_table(){
        $.extend( true, $.fn.dataTable.defaults, {
            dom:
                "<'row be-datatable-header'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row be-datatable-body'<'col-sm-12'tr>>" +
                "<'row be-datatable-footer'<'col-sm-5'i><'col-sm-7'p>>"
        } );

        var dataTableConfig = {
            "bPaginate": true,  //是否分页。
            "bStateSave": true,
            "aLengthMenu": [5, 3, 1],
            "language": {
                "emptyTable": "没有可以选择的医生",
                "info": "显示 _START_ 到 _END_ 条数据 共 _TOTAL_ 条数据",
                "infoEmpty": "无数据",
                "infoFiltered": "(在 _MAX_ 条数据中查询)",
                "lengthMenu": "显示 _MENU_ 条数据",
                "search": "查询:",
                "zeroRecords": "没有找到对应的数据",
                "paginate": {
                    "previous":"上一页",
                    "next": "下一页",
                    "last": "末页",
                    "first": "首页"
                }
            },
            "columns": [
                {"data": "odId", "title": "医生id"},
                {"data": "name", "title": "医生姓名"},
                {"data": "reglCode", "title" : "挂号级别"},
                {"data": "deptName", "title": "科室名称"},
                {"data": "patNumber", "title": "看诊数量"},
                {"data": "limitation", "title": "挂号限额"},
                {"data": "operate", "title": "操作"}
            ]
        };

        $("#doctor-table").dataTable(dataTableConfig);
    }


    // 检查挂号所提交的表单是否合法
    function check_reg() {
        const patName = document.forms["reg-form"]["patName"].value;
        const patId = document.forms["reg-form"]["patId"].value;
        const birthday = document.forms["reg-form"]["birthday"].value;
        const address = document.forms["reg-form"]["address"].value;
        const odId = document.forms["reg-form"]["odId"].value;
        const deptId = document.forms["reg-form"]["deptId"].value;
        const reglCode = document.forms["reg-form"]["reglCode"].value;

        if (patName === null || patName === ""){
            document.getElementById('reg-err').innerText = "患者姓名不能为空";
            return false;
        }

        const idNo = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
        if (patId === null || patId === "" || !idNo.test(patId)){
            document.getElementById('reg-err').innerText = "患者身份证号格式错误";
            return false;
        }

        if (birthday === null || birthday === ""){
            document.getElementById('reg-err').innerText = "患者出生日期不能为空";
            return false;
        }

        if (address === null || address === ""){
            document.getElementById('reg-err').innerText = "患者住址不能为空";
            return false;
        }

        const num = /^[1-9]\d*$/;

        if (odId === null || odId === "" || !num.test(odId)){
            document.getElementById('reg-err').innerText = "医生id必需为数字";
            return false;
        }

        // if (deptId === null || deptId === "" || !num.test(deptId)){
        if (deptId === null || deptId === ""){
            // document.getElementById("reg-err").innerText = "科室id必需为数字";
            document.getElementById("reg-err").innerText = "科室未选择";
            return false;
        }

        if (reglCode === null || reglCode === ""){
            document.getElementById("reg-err").innerText = "挂号级别不能为空";
            return false;
        }
        return true;
    }


    // 检查查找病人提交的表单数据是否合法
    function check_Medical_no() {
        const medicalNo = document.forms["patient-finder"]["medicalNo"].value;
        const num = /^[1-9]\d*$/;

        if (medicalNo === null || !num.test(medicalNo)){
            document.getElementById("finder-err").innerText = "输入的病历号必需为数字";
            return false;
        }
        document.getElementById("finder-err").innerText = "";
        return true;
    }

</script>

</body>
</html>