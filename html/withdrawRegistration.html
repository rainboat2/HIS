<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" href="assets/img/logo-fav.png">
    <title>HIS</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">

    <link rel="stylesheet" type="text/css" href="assets/lib/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="assets/css/style_me.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/perfect-scrollbar/css/perfect-scrollbar.min.css"/>
    <link rel="stylesheet" type="text/css" href="assets/lib/material-design-icons/css/material-design-iconic-font.min.css"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
</head>
<body>
<div class="be-wrapper be-fixed-sidebar">
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-default navbar-fixed-top be-top-header">
        <div class="container-fluid">
            <!-- 左上角log -->
            <div class="navbar-header">
                <a href="#" class="navbar-brand"></a>
            </div>

            <div class="be-right-navbar">
                <ul class="nav navbar-nav navbar-right be-user-nav">
                    <li class="dropdown">
                        <a href="#" data-toggle="dropdown" role="button" aria-expanded="false" class="dropdown-toggle">
                            <img src="assets/img/avatar.png" alt="Avatar">
                            <span class="user-name">${sessionScope.userId}</span>
                        </a>
                        <ul role="menu" class="dropdown-menu">
                            <li>
                                <div class="user-info">
                                    <div class="user-name">${sessionScope.userId}</div>
                                </div>
                            </li>
                            <li>
                                <a onclick="$.quit('${pageContext.request.contextPath}');return false;">
                                    <span class="icon mdi mdi-power"></span>注销
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 左侧边导航栏 -->
    <div class="be-left-sidebar">
        <div class="left-sidebar-wrapper"><a href="#" class="left-sidebar-toggle">Dashboard</a>
            <div class="left-sidebar-spacer">
                <div class="left-sidebar-scroll">
                    <div class="left-sidebar-content">
                        <ul class="sidebar-elements">
                            <li class="divider">菜单</li>
                            <li class="parent"><a href="#"><i class="icon mdi mdi-face"></i><span>挂号收费</span></a>
                                <ul class="sub-menu">
                                    <li><a href="register.html">挂号</a>
                                    </li>
                                    <li class="active"><a href="#">退号</a>
                                    </li>
                                    <li><a href="abnormalInvoiceProcess.html">异常发票处理</a>
                                    </li>
                                    <li><a href="payWithdraw.html">收退费</a>
                                    </li>
                                    <li><a href="dailySettlement.html">日结</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页面主内容 -->
    <div class="be-content">
        <div class="main-content container-fluid">
            <div class="row">
                <div class="col-sm-12">
                    <div class="panel panel-default panel-table">
                        <div class="panel-heading"></div>
                        <!-- 信息输入/查看面板-->
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-sm-12">
                                    <table class="col-sm-12">
                                        <tr>
                                            <td style="width:12%"><b>患者信息查询</b></td>
                                        </tr>
                                        <tr>
                                            <td style="width:8%;text-align:center;">
                                                <label for="medicalNo">病历号</label>
                                            </td>
                                            <td style="width:24%;">
                                                <input id = "medicalNo" type="text" placeholder="病历号" autocomplete="off" class="form-control input-sm">
                                            </td>
                                            <td style="width:8%;text-align:right">
                                                <button class="btn btn-space btn-primary" onclick="findRegistration()">
                                                    <i class="icon icon-left mdi mdi-search"></i> 搜索
                                                </button>
                                            </td>
                                            <td>
                                                <p id = "finder-err" style="color: Red"></p>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><b>患者信息确认</b></td>
                                        </tr>
                                        <tr>
                                            <td style="width:8%;text-align:center;">
                                                <label for="name">姓名</label>
                                            </td>
                                            <td style="width:24%;">
                                                <input id="name" type="text" readonly="readonly" class="form-control input-sm">
                                            </td>
                                            <td style="width:8%;;text-align:center;">
                                                <label for="idNumber">身份证号</label>
                                            </td>
                                            <td style="width:24%">
                                                <input id="idNumber" type="text" readonly="readonly" class="form-control input-sm">
                                            </td>
                                            <td style="width:8%;;text-align:center;">
                                                <label for="address">家庭住址</label>
                                            </td>
                                            <td style="width:24%">
                                                <input id="address" type="text" readonly="readonly" class="form-control input-sm">
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- 挂号表格-->
                        <div class="panel-heading">
                            患者挂号信息
                        </div>
                        <div class="panel-body">
                            <table id="reg-table" class="table table-striped table-hover table-fw-widget">
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>

<script type="text/javascript">


    class PatientInfo{
        constructor(name, id, address){
            this.name = name;
            this.idNumber = id;
            this.address = address;
        }
    }

    class RegisInfo{
        constructor(id, name, idNumber, regId, regState, regTime, deptName){
            this.id = id;
            this.name = name;
            this.idNumber =  idNumber;
            this.regId = regId;
            this.regState = regState;
            this.regTime =  regTime;
            this.deptName =  deptName;
            this.flag  =  1;
        }
    }

    regs = [];
    regs[0] = new RegisInfo('1', '李六','123456789987654321','123', '未看诊', '2020-3-21', '眼科');
    regs[1] = new RegisInfo('2', '李六','123456789987654321','163', '未看诊', '2020-4-12', '眼科');
    regs[2] = new RegisInfo('3', '李六','123456789987654321','223', '未看诊', '2020-5-5', '眼科');

    // 根据病历号，查找所有对应的挂号单
    function findRegistration() {
        if (!check_Medical_no())
            return;

        const mdNo = document.getElementById("medicalNo").value;

        if (mdNo === '1')
            layer.msg("病历号不存在",{icon:2,time:1000});
        else{
            let p = new PatientInfo('李六','123456789987654321','沈阳');
            $("#name").val(p.name);
            $("#idNumber").val(p.idNumber);
            $("#address").val(p.address);

            in_regs = [];
            var cnt = 0;
            for (var i = 0; i < 3; ++i){
                if (regs[i].flag === 1)
                    in_regs[cnt++] = regs[i];
            }
            fillRegTable(in_regs);
        }

    }

    function check_Medical_no() {
        const medicalNo = document.getElementById("medicalNo").value;
        const num = /^[1-9]\d*$/;
        const err = $("#finder-err");
        if (medicalNo === null || !num.test(medicalNo)){
            err.text("输入的病历号必需为数字");
            return false;
        }
        err.text("");
        return true;
    }

    function fillRegTable(info) {
        const table = $("#reg-table").DataTable();
        table.clear();
        const regList = info;
        for (var i = 0; i < regList.length; i++){
            var reg = regList[i];
            table.row.add({
                "name": reg.name,
                "idNumber": reg.idNumber,
                "regId": reg.regId,
                "regState": reg.regState,
                "regTime": reg.regTime,
                "deptName": reg.deptName,
                "operate" : "<button class=\"btn btn-space btn-primary\" onclick=\"withdrawRegistration("
                    +  reg.id +")\">退号</button>"
            })
        }
        table.draw();
    }

    function withdrawRegistration(regId){
        console.log(regId);
        var reg;
        for (var i = 0; i < regs.length; ++i){
            if (regs[i].id == regId){   //传数据过来的时候当作数字了,所以用“==”而不用“===”
                reg = regs[i];
                break;
            }
        }
        console.log(reg);
        if (reg.regState === '未看诊'){
            reg.flag = 0;
            layer.msg("已成功退号",{icon:1,time:1000});
            setTimeout(function(){findRegistration();}, 1000);
        }
        else{
            layer.msg("只有未看诊的才能退号",{icon:2,time:1000});
        }
    }

    //TODO: modifyState 修改表格中的状态

</script>

<script src="assets/lib/jquery/jquery.min.js" type="text/javascript"></script>
<script src="assets/lib/perfect-scrollbar/js/perfect-scrollbar.jquery.min.js" type="text/javascript"></script>
<script src="assets/js/main.js" type="text/javascript"></script>
<script src="assets/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/js/dataTables.bootstrap.min.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/dataTables.buttons.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.html5.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.flash.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.print.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.colVis.js" type="text/javascript"></script>
<script src="assets/lib/datatables/plugins/buttons/js/buttons.bootstrap.js" type="text/javascript"></script>
<script src="assets/js/app-tables-datatables.js" type="text/javascript"></script>
<script src="assets/lib/jquery-ui/jquery-ui.min.js" type="text/javascript"></script>
<script src="assets/lib/jquery.nestable/jquery.nestable.js" type="text/javascript"></script>
<script src="assets/lib/moment.js/min/moment.min.js" type="text/javascript"></script>
<script src="assets/lib/datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script src="assets/lib/daterangepicker/js/daterangepicker.js" type="text/javascript"></script>
<script src="assets/lib/select2/js/select2.min.js" type="text/javascript"></script>
<script src="assets/lib/select2/js/select2.full.min.js" type="text/javascript"></script>
<script src="assets/lib/bootstrap-slider/js/bootstrap-slider.js" type="text/javascript"></script>
<script src="assets/js/myjs/common.js"  type="text/javascript"></script>
<script type="text/javascript" src="assets/lib/layui/layui.all.js"></script>

<script type="text/javascript">
    $(document).ready(function(){
        App.init();
        init_reg_table();
    });

    function init_reg_table(){
        $.extend( true, $.fn.dataTable.defaults, {
            dom:
                "<'row be-datatable-header'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row be-datatable-body'<'col-sm-12'tr>>" +
                "<'row be-datatable-footer'<'col-sm-5'i><'col-sm-7'p>>"
        } );

        const dataTableConfig = {
            "bPaginate": true,  //是否分页。
            "bStateSave": true,
            "aLengthMenu": [5, 3, 1],
            "language": {
                "emptyTable": "无挂号信息",
                "info": "显示 _START_ 到 _END_ 条数据 共 _TOTAL_ 条数据",
                "infoEmpty": "无数据",
                "infoFiltered": "(在 _MAX_ 条数据中查询)",
                "lengthMenu": "显示 _MENU_ 条数据",
                "search": "查询:",
                "zeroRecords": "没有找到对应的数据",
                "paginate": {
                    "previous":"上一页",
                    "next": "下一页",
                    "last": "末页",
                    "first": "首页"
                }
            },
            "columns": [
                {"data": "name", "title": "姓名"},
                {"data": "idNumber", "title": "身份证号"},
                {"data": "regId", "title": "挂号id"},
                {"data": "regState", "title": "状态"},
                {"data": "regTime", "title": "挂号时间"},
                {"data": "deptName", "title": "科室"},
                {"data": "operate", "title": "操作"}
            ]
        };

        $("#reg-table").dataTable(dataTableConfig);
    }
</script>
</html>
